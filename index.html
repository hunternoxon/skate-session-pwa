<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Brainlock Inline ‚Äî STABLE hotfix</title>
<meta name="theme-color" content="#0b0b0c"/>
<style>
:root{--bg:#0b0b0c;--card:#141416;--muted:#8a8e93;--text:#f3f4f6;--ghost:#1c1d20;--border:#222327;--ok:#22c55e;--bad:#ef4444}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--text);font:16px -apple-system,system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;line-height:1.35}
.hidden{display:none!important}
.topbar{position:sticky;top:0;z-index:7;display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border);background:rgba(11,11,12,.85);backdrop-filter:blur(8px)}
.brand{font-weight:800;letter-spacing:.2px;margin:0;cursor:pointer;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.icon-btn{background:var(--ghost);color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:9999px;min-height:36px}
.primary{background:#fff;color:#0b0b0c;border:1px solid #fff;padding:14px 18px;border-radius:9999px;font-weight:800}
.success{background:var(--ok);color:#051507;border:none;padding:14px 18px;border-radius:9999px;font-weight:800}
.danger{background:var(--bad);color:#160203;border:none;padding:14px 18px;border-radius:9999px;font-weight:800}
.ghost{background:var(--ghost);color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:9999px}
.card{margin:16px;padding:16px;border:1px solid var(--border);border-radius:16px;background:var(--card)}
.sheet{position:fixed;left:0;right:0;bottom:0;z-index:3;border-top-left-radius:18px;border-top-right-radius:18px;margin:0;padding:16px;background:var(--card);max-height:58vh;overflow:auto;padding-bottom:calc(env(safe-area-inset-bottom) + 28px)}
.headerline{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
.letters{display:flex;justify-content:center;gap:.8ch}
.letters>span{font-weight:900;font-size:clamp(26px,9vw,48px);color:#7f858c}
.letters>span.lost{color:#ffffff}
.badge{font-size:12px;color:#cbd5e1;background:#0b0c0e;border:1px solid var(--border);padding:4px 8px;border-radius:9999px}
.scoreline{
  display:flex;align-items:center;gap:8px;flex-wrap:wrap
}
.pill{border:1px solid var(--border);border-radius:9999px;padding:4px 8px;font-weight:700}
.trick{font-size:28px;font-weight:800;padding:16px;background:#101215;border:1px dashed var(--border);border-radius:14px;min-height:72px;display:flex;flex-direction:column;gap:10px}
.trick-top{display:flex;justify-content:space-between;align-items:center}
.actions{display:flex;gap:12px;justify-content:flex-end;margin:16px 0;flex-wrap:wrap}
.foot{padding:16px;color:var(--muted);border-top:1px solid var(--border)}
/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:10}
.modal.hidden{display:none !important;pointer-events:none !important}
.modal-card{background:#141416;border:1px solid var(--border);border-radius:16px;max-width:860px;width:92vw;max-height:88vh;display:flex;flex-direction:column;overflow:hidden}
.modal-header,.modal-footer{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
.modal-header h3{margin:0}
.pane{padding:14px;overflow:auto;max-height:70vh}
/* Tricks overlay hierarchy */
.list{display:flex;flex-direction:column;gap:8px}
.list label.cat{font-size:28px;font-weight:900;padding:12px 14px;background:#101215;border:1px solid #2a2b2f;display:block;margin:10px 0 8px 0;border-radius:14px}
.list input[type="checkbox"].cat{transform:scale(1.6)}
.list .sub{margin:8px 0 20px 16px;border-left:2px solid #232429;padding-left:12px}
.list .sub label{font-size:14px;font-weight:600;background:#0e0f11;border:1px solid #1f2024;border-radius:12px;padding:8px 10px}
.hr{height:1px;background:#222327;margin:10px 0}
</style>
</head>
<body>
<header class="topbar">
  <h1 id="title" class="brand">Brainlock Skateboard Game</h1>
  <button id="dbg" class="icon-btn">DBG</button>
  <button id="gear" class="icon-btn" aria-label="Settings">‚öôÔ∏è</button>
</header>

<main>
  <section class="sheet card">
    <div class="headerline">
      <div id="letters" class="letters"><span>S</span><span>K</span><span>A</span><span>T</span><span>E</span></div>
      <div class="scoreline">
        <span id="scoreLine" class="pill">High Score: <button id="openHigh" class="ghost">0 pts</button></span>
        <span class="pill">Level <span id="levelVal">1</span> <button id="editLevel" class="ghost">edit</button></span>
      </div>
    </div>

    <div id="viewSetup">
      <div style="text-align:center;font-size:42px;margin:8px 0 14px">üß† üîí üõπ</div>
      <button id="start" class="primary">Start Session</button>
    </div>

    <div id="viewGame" class="hidden">
      <div id="trickBox" class="trick">
        <div class="trick-top">
          <span id="attempt" class="badge">Attempt 1/3</span>
          <button id="openAttempt" class="badge">This attempt: ‚Äî</button>
        </div>
        <div id="trickText">‚Äî</div>
      </div>
      <div class="actions">
        <button id="skip" class="ghost">Skip</button>
        <button id="miss" class="danger">Miss</button>
        <button id="land" class="success">Land</button>
        <button id="next" class="primary hidden">Next</button>
      </div>
      <div><button id="end" class="ghost">End Session</button></div>
    </div>

    <div id="viewOver" class="hidden">
      <div style="text-align:center;font-size:42px;margin:8px 0 14px">üß† üîí üõπ</div>
      <div style="display:flex;justify-content:space-between;font-weight:800">
        <div>Final: <span id="final">0 pts</span></div>
        <div>High: <button id="openHigh2" class="ghost">0 pts</button></div>
      </div>
      <button id="restart" class="primary">New Session</button>
    </div>
  </section>
</main>

<footer class="foot">v0.5.6-inline-STABLE-hotfix ‚Ä¢ Updated: 2025-08-13</footer>

<!-- Settings Modal -->
<div id="settings" class="modal hidden" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header"><h3>Settings</h3><button id="closeSettings" class="ghost">X</button></div>
    <div class="pane">
      <div class="list">
        <label class="cat">Game Options</label>
        <div class="sub">
          <div class="row">Level:
            <div style="display:flex;gap:8px;align-items:center">
              <input id="levelInput" type="range" min="1" max="10" value="1"/>
              <span id="levelDesc">Beginner basics</span>
            </div>
          </div>
          <div class="hr"></div>
          <label><input id="betaToggle" type="checkbox"/> Use Beta Scoring & Selector</label>
          <div style="color:#8a8e93;font-size:12px;margin-top:6px">Beta OFF keeps stable behavior. Beta ON uses tuned scoring/selector.</div>
        </div>

        <label class="cat">About & Tools</label>
        <div class="sub">
          <button id="clearCache" class="ghost">Clear cache & reload</button>
          <div style="font-size:12px;color:#8a8e93">Version: v0.5.6-inline-STABLE-hotfix ‚Ä¢ 2025-08-13</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- High Score Modal -->
<div id="highmodal" class="modal hidden" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header"><h3>Leaderboard (Top 10)</h3><button id="closeHigh" class="ghost">X</button></div>
    <div class="pane" id="highBody"></div>
  </div>
</div>

<!-- Attempt Breakdown Modal -->
<div id="attemptmodal" class="modal hidden" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header"><h3>Attempt Score Breakdown</h3><button id="closeAttempt" class="ghost">X</button></div>
    <div class="pane" id="attemptBody"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Hide modals hard on boot
  ['settings','highmodal','attemptmodal'].forEach(id=>{const m=document.getElementById(id); if(m){m.classList.add('hidden'); m.setAttribute('aria-hidden','true')}});

  const $=id=>document.getElementById(id);
  const els={title:$('#title'),dbg:$('#dbg'),gear:$('#gear'),
    letters:$('#letters'),scoreLine:$('#scoreLine'),
    levelVal:$('#levelVal'),editLevel:$('#editLevel'),
    viewSetup:$('#viewSetup'),viewGame:$('#viewGame'),viewOver:$('#viewOver'),
    start:$('#start'),skip:$('#skip'),miss:$('#miss'),land:$('#land'),next:$('#next'),
    end:$('#end'),restart:$('#restart'),trickText:$('#trickText'),attempt:$('#attempt'),
    openAttempt:$('#openAttempt'),final:$('#final'),openHigh:$('#openHigh'),openHigh2:$('#openHigh2'),
    settings:$('#settings'),closeSettings:$('#closeSettings'),
    levelInput:$('#levelInput'),levelDesc:$('#levelDesc'),betaToggle:$('#betaToggle'),
    highmodal:$('#highmodal'),highBody:$('#highBody'),closeHigh:$('#closeHigh'),
    attemptmodal:$('#attemptmodal'),attemptBody:$('#attemptBody'),closeAttempt:$('#closeAttempt')
  };

  function setNextVisible(on){ els.next.classList.toggle('hidden', !on); [els.skip, els.miss, els.land].forEach(b=> b.classList.toggle('hidden', on)); }

  let misses=0,total=0,attempt=1,level=1,usingBeta=false;
  const HS_KEY='brainlock_hiscore_v1';
  function getHigh(){ try{return JSON.parse(localStorage.getItem(HS_KEY))||[]}catch(e){return[]} }
  function setHigh(arr){ localStorage.setItem(HS_KEY, JSON.stringify(arr.slice(0,10))); }

  function updateLetters(){ [...els.letters.children].forEach((s,i)=> s.classList.toggle('lost', i<misses)); }
  function setView(v){
    els.viewSetup.classList.toggle('hidden', v!=='setup');
    els.viewGame.classList.toggle('hidden', v!=='game');
    els.viewOver.classList.toggle('hidden', v!=='over');
    if(v==='setup'){ els.scoreLine.innerHTML='High Score: <button id="openHigh" class="ghost">0 pts</button>'; bindHighBtn(); }
    if(v==='game'){ els.scoreLine.textContent='Total Score: '+total+' pts'; }
  }
  function bindHighBtn(){ const btn=document.getElementById('openHigh'); if(btn){ btn.addEventListener('click', openHigh ); } }

  function describe(c){
    let s=''; if(c.stance&&c.stance!=='regular') s+=c.stance+' ';
    if(c.flip) s+=c.flip+' '; if(c.grind) s+=c.grind+' ';
    s+='on '+(c.obstacle||'flat'); if(c.direction) s=(c.direction+' '+s).trim();
    if(c.spin) s=(s+' '+c.spin).trim(); return s.trim();
  }

  const FLIPS=['kickflip','heelflip','varial kickflip','hardflip','tre flip'];
  const GRINDS=['50-50','5-0','boardslide','noseslide','tailslide','lipslide','smith','feeble','crooked','nosegrind','bluntslide','noseblunt'];
  const OBST_BASE=['flat','ledge','rail','handrail','gap'];
  const STANCES=['regular','fakie','nollie','switch'];
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }

  function genStable(){
    const ob = pick(OBST_BASE);
    if(ob==='flat'||ob==='gap') return { obstacle:ob, flip: pick(FLIPS), stance: pick(STANCES) };
    if(ob==='ledge') return { obstacle:ob, grind: pick(GRINDS), direction: Math.random()<.5?'frontside':'backside', stance: pick(STANCES) };
    return { obstacle:ob, grind: pick(GRINDS), direction: Math.random()<.5?'frontside':'backside', stance: pick(STANCES) };
  }

  function genBeta(){
    const ob = pick(OBST_BASE);
    const stance = pick(STANCES);
    const dir = Math.random()<.5?'frontside':'backside';
    const spin = (Math.random()<spinWeightByLevel()? (Math.random()<0.6?180:360): 0);
    if(ob==='flat') return { obstacle:ob, flip: pick(FLIPS), stance, spin };
    if(ob==='gap') return { obstacle:ob, flip: pick(FLIPS), stance, spin };
    if(ob==='ledge'){
      if(Math.random()<0.6) return { obstacle:ob, grind: pick(GRINDS), direction:dir, stance, spin };
      return { obstacle:ob, flip: pick(FLIPS), grind: pick(GRINDS), direction:dir, stance, spin };
    }
    if(ob==='rail'||ob==='handrail'){
      if(Math.random()<0.75) return { obstacle:ob, grind: pick(GRINDS), direction:dir, stance, spin };
      return { obstacle:ob, flip: pick(FLIPS), grind: pick(GRINDS), direction:dir, stance, spin };
    }
    return { obstacle:'flat', flip:'kickflip', stance };
  }
  function spinWeightByLevel(){ if(level<=3) return 0.08; if(level<=6) return 0.28; return 0.5; }

  function computeScore(c,att){
    let pts=0;
    if(c.flip) pts += {'kickflip':200,'heelflip':220,'varial kickflip':280,'hardflip':340,'tre flip':360}[c.flip]||220;
    if(c.grind) pts += {'50-50':220,'5-0':260,'boardslide':230,'noseslide':240,'tailslide':270,'lipslide':300,'smith':340,'feeble':360,'crooked':340,'nosegrind':360,'bluntslide':420,'noseblunt':460}[c.grind]||240;
    const obstM = {'flat':1.0,'ledge':1.2,'rail':1.4,'handrail':1.6,'gap':1.5}[c.obstacle]||1.0;
    const stanceM = {'regular':1.0,'fakie':1.2,'nollie':1.25,'switch':1.25}[c.stance||'regular']||1.0;
    const spinM = (c.spin==180?1.1:(c.spin==360?1.3:1.0));
    pts = Math.round(pts*obstM*stanceM*spinM);
    const attM = att==1?1.0:att==2?0.85:0.75;
    const final = Math.max(1, Math.round(pts*attM));
    return { final, breakdown:[['base',pts],['obstacle',c.obstacle,obstM],['stance',c.stance||'regular',stanceM],['spin', String(c.spin||0), spinM],['attempt','x'+att,attM]] };
  }

  let current=null;
  function nextTrick(){
    attempt=1; current = (usingBeta? genBeta(): genStable());
    els.trickText.textContent = describe(current);
    els.attempt.textContent='Attempt 1/3';
    setNextVisible(false);
    els.skip.disabled=false; els.miss.disabled=false; els.land.disabled=false;
    els.openAttempt.textContent='This attempt: ‚Äî';
  }

  function settle(hit){
    if(hit){
      const rep=computeScore(current,attempt);
      total+=rep.final;
      els.scoreLine.textContent='Total Score: '+total+' pts';
      els.openAttempt.textContent='This attempt: '+rep.final+' pts';
      els.attemptBody.innerHTML = '<div><strong>Final:</strong> '+rep.final+' pts</div>' + rep.breakdown.map(r=>'<div>'+r[0]+': '+(r[1]||'')+' '+(r[2]?'√ó'+r[2]:'')+'</div>').join('');
      setNextVisible(true);
      els.skip.disabled=true; els.miss.disabled=true; els.land.disabled=true;
    } else {
      if(attempt<3){
        attempt++; els.attempt.textContent='Attempt '+attempt+'/3';
      } else {
        misses++; updateLetters();
        setNextVisible(true);
        els.skip.disabled=true; els.miss.disabled=true; els.land.disabled=true;
      }
    }
  }

  function endSession(){
    els.final.textContent=total+' pts';
    const board = getHigh(); board.push({score:total, name:'anon', date:Date.now()}); board.sort((a,b)=>b.score-a.score); setHigh(board);
    els.viewGame.classList.add('hidden'); els.viewOver.classList.remove('hidden');
  }

  function openHigh(){
    const board=getHigh();
    if(!board.length){ els.highBody.textContent='No scores yet.'; }
    else { els.highBody.innerHTML = '<ol>'+ board.slice(0,10).map((r,i)=>'<li>'+(i+1)+'. '+(r.name||'anon')+' ‚Äî '+r.score+' pts</li>').join('') + '</ol>'; }
    els.highmodal.classList.remove('hidden');
  }
  function closeHigh(){ els.highmodal.classList.add('hidden'); }

  // Wire
  els.dbg.addEventListener('click', ()=>alert('JS live STABLE hotfix'));
  els.title.addEventListener('click', ()=>location.reload());
  els.gear.addEventListener('click', ()=>els.settings.classList.remove('hidden'));
  els.closeSettings.addEventListener('click', ()=>els.settings.classList.add('hidden'));
  document.getElementById('clearCache').addEventListener('click', ()=>{ try{ caches&&caches.keys().then(keys=>keys.forEach(k=>caches.delete(k))) }catch(e){} localStorage.clear(); location.reload(); });
  els.levelInput.addEventListener('input', (e)=>{ level=+e.target.value; els.levelVal.textContent=String(level); els.levelDesc.textContent = level<=3?'Beginner basics': level<=6?'Intermediate': level<=8?'Advanced':'Pro+'; });
  els.betaToggle.addEventListener('change', e=> usingBeta = e.target.checked);

  function startSession(){ misses=0; total=0; attempt=1; updateLetters(); setView('game'); nextTrick(); }
  function restart(){ setView('setup'); }
  // Buttons
  els.start.addEventListener('click', startSession);
  els.skip.addEventListener('click', ()=>{ setNextVisible(false); nextTrick(); });
  els.miss.addEventListener('click', ()=>settle(false));
  els.land.addEventListener('click', ()=>settle(true));
  els.next.addEventListener('click', ()=> nextTrick());
  els.end.addEventListener('click', ()=>{ if(confirm('End session?')){ endSession(); } });
  els.restart.addEventListener('click', ()=>{ setView('setup'); });
  els.openHigh.addEventListener('click', openHigh);
  els.openHigh2.addEventListener('click', openHigh);
  els.closeHigh.addEventListener('click', closeHigh);
  els.openAttempt.addEventListener('click', ()=> els.attemptmodal.classList.remove('hidden'));
  els.closeAttempt.addEventListener('click', ()=> els.attemptmodal.classList.add('hidden'));

  // boot
  setView('setup'); updateLetters();
});
</script>
</body>
</html>
