const VERSION="0.4.2";const DEFAULTS={categories:{flips:true,grinds:true,manuals:true,airs:true,spins:true},stances:{regular:true,fakie:true,nollie:true,switch:true},flips:{"kickflip":true,"heelflip":true,"varial kickflip":true,"varial heelflip":true,"hardflip":true,"inward heelflip":true,"bigspin flip":true,"bigspin heelflip":true,"tre flip":true,"360 flip":true,"laser flip":true},grinds:{"50-50":true,"5-0":true,"boardslide":true,"noseslide":true,"tailslide":true,"lipslide":true,"smith":true,"feeble":true,"willy":true,"salad":true,"crooked":true,"overcrook":true,"nosegrind":true,"noseblunt":true,"bluntslide":true},spins:{"180":true,"360":true,"540":true,"720":true},obstacles:["flat","ledge","rail","manual pad","quarterpipe","bank","kicker"]};function loadState(){try{return JSON.parse(localStorage.getItem('bl_state'))||DEFAULTS}catch{return DEFAULTS}}function saveState(s){localStorage.setItem('bl_state',JSON.stringify(s))}let STATE=loadState();const ALL_OBS=["flat","curb","ledge","flatbar","handrail","rail","hubba","kicker","gap","stair","quarterpipe","bank","mini ramp","funbox","manual pad","box"];const RULES={DIRECTION_DEFAULTS:{"50-50":"frontside","5-0":"frontside","boardslide":"backside","noseslide":"backside","lipslide":"frontside","tailslide":"frontside","bluntslide":"backside","nosegrind":"frontside","crooked":"backside","willy":"backside","feeble":"backside","smith":"backside","salad":"backside","overcrook":"backside","noseblunt":"frontside"},STANCES:["regular","switch","nollie","fakie"],DIRECTIONS:["frontside","backside"],SPINS:[180,360,540,720],FLIPS:["kickflip","heelflip","hardflip","inward heelflip","varial kickflip","varial heelflip","tre flip","360 flip","laser flip","bigspin flip","bigspin heelflip"],GRINDS_SLIDES:["50-50","5-0","boardslide","noseslide","tailslide","lipslide","smith","feeble","willy","salad","crooked","overcrook","nosegrind","noseblunt","bluntslide"],MANUALS:["manual","nose manual","one wheel manual"],GRIND_OK:new Set(["rail","handrail","flatbar","ledge","hubba"]),SLIDE_OK:new Set(["ledge","hubba","rail","handrail","flatbar","curb","box"]),MANUAL_OK:new Set(["manual pad","box","funbox","kicker","bank"]),AIR_OK:new Set(["flat","gap","kicker","quarterpipe","bank","stair","funbox"])};const BASE_POINTS={stance:{regular:0,fakie:.1,nollie:.2,switch:.3},spin:{180:.2,360:.4,540:.6,720:.8},flip:{kickflip:.3,heelflip:.35,hardflip:.55,"inward heelflip":.6,"varial kickflip":.45,"varial heelflip":.5,"tre flip":.8,"360 flip":.8,"laser flip":.85,"bigspin flip":.6,"bigspin heelflip":.65},grind_slide:{"50-50":.3,"5-0":.4,boardslide:.4,noseslide:.45,tailslide:.5,lipslide:.55,smith:.65,feeble:.65,willy:.55,salad:.6,crooked:.65,overcrook:.75,nosegrind:.7,noseblunt:.9,bluntslide:.85},obstacle:{flat:0,"manual pad":.1,box:.1,curb:.15,ledge:.25,hubba:.35,flatbar:.35,rail:.45,handrail:.55,gap:.5,kicker:.1,stair:.45,quarterpipe:.4,bank:.25,funbox:.2,"mini ramp":.3},manual:{manual:.25,"nose manual":.35,"one wheel manual":.6}};const COMBO_BONUSES={spin_plus_flip:.2,flip_into_grind:.25,spin_into_grind:.15,manual_combo:.15};function tier(e){return Math.max(1,Math.min(10,e|0))}const SCORE_CAP={1:1.9,2:2.2,3:2.5,4:2.9,5:3.3,6:3.7,7:4.1,8:4.6,9:5.3,10:6};function scoreCapFor(e){return SCORE_CAP[tier(e)]}function allowFlip(e,n){const t=["tre flip","360 flip","laser flip","bigspin heelflip","hardflip","inward heelflip"],i=["varial kickflip","varial heelflip","bigspin flip"];return n<=1?["kickflip","heelflip"].includes(e):n<=2?!t.includes(e)&&!i.includes(e):n<=4?!t.includes(e):5===n?"laser flip"!==e:9===n?!"kickflip,heelflip".split(",").includes(e):!0}function allowGrindSlide(e,n){const t=["overcrook","noseblunt","bluntslide"];return n<=1?["50-50","boardslide","5-0","noseslide","tailslide"].includes(e):n<=2?!t.includes(e)&&!["smith","feeble","overcrook"].includes(e):n<=4?!t.includes(e)||"overcrook"===e:9===n?t.includes(e)||["crooked","nosegrind","5-0"].includes(e):!0}function allowSpin(e,n){return n<=2?e<=180:n<=4?e<=360:n<=7?e<=540:8===n?e<=720:!0}function stanceEnabled(e){return!!STATE.stances[e]}function stancePool(e){const n=Object.keys(STATE.stances).filter((e=>STATE.stances[e]));return e<=2?n.filter((e=>"switch"!==e)):n}let currentSkill=6;function underScoreCap(e){const n=computeScore(e,1);return n.base<=scoreCapFor(currentSkill||6)}const HISTORY_WINDOW=7,DUPLICATE_THRESHOLD=.82;let _recent=[];function pushRecent(e){_recent.unshift(e),_recent.length>HISTORY_WINDOW&&_recent.pop()}function similarity(e,n){const t=["stance","spin","flip","grind_slide","direction","manual","obstacle"];let i=0;for(const a of t)(!e[a]&&!n[a]||e[a]&&n[a]&&String(e[a])===String(n[a]))&&i++;return i/t.length}function notTooSimilar(e){for(const n of _recent)if(similarity(e,n)>=DUPLICATE_THRESHOLD)return!1;return!0}function pickObstacle(){const e=(STATE.obstacles&&STATE.obstacles.length?STATE.obstacles:DEFAULTS.obstacles).filter((e=>ALL_OBS.includes(e)));return e.length?e[Math.floor(Math.random()*e.length)]:"flat"}function isValidCombo(e){const n=e.grind_slide,t=e.manual,i=e.obstacle,a=e.flip;if(n){const e=["boardslide","lipslide","tailslide","noseslide","bluntslide"].includes(n);if(!i)return!1;if(e&&!RULES.SLIDE_OK.has(i))return!1;if(!e&&!(RULES.GRIND_OK.has(i)||RULES.SLIDE_OK.has(i)))return!1}return!(!t||!i||RULES.MANUAL_OK.has(i))||!(!a||n||t||!i||RULES.AIR_OK.has(i))}function baseScore(e){let n=1,t=[];const i=e.stance||"regular";n+=BASE_POINTS.stance[i]||0,t.push(["stance",i,BASE_POINTS.stance[i]||0]),e.spin&&(n+=BASE_POINTS.spin[e.spin]||0,t.push(["spin",e.spin,BASE_POINTS.spin[e.spin]||0])),e.flip&&(n+=BASE_POINTS.flip[e.flip]||0,t.push(["flip",e.flip,BASE_POINTS.flip[e.flip]||0])),e.grind_slide&&(n+=BASE_POINTS.grind_slide[e.grind_slide]||0,t.push(["grind_slide",e.grind_slide,BASE_POINTS.grind_slide[e.grind_slide]||0])),e.manual&&(n+=BASE_POINTS.manual[e.manual]||0,t.push(["manual",e.manual,BASE_POINTS.manual[e.manual]||0])),e.obstacle&&(n+=BASE_POINTS.obstacle[e.obstacle]||0,t.push(["obstacle",e.obstacle,BASE_POINTS.obstacle[e.obstacle]||0]));let a=0;return e.spin&&e.flip&&(a+=COMBO_BONUSES.spin_plus_flip),e.flip&&e.grind_slide&&(a+=COMBO_BONUSES.flip_into_grind),e.spin&&e.grind_slide&&(a+=COMBO_BONUSES.spin_into_grind),e.manual&&(e.flip||e.spin)&&(a+=COMBO_BONUSES.manual_combo),n*=(1+a),{score:Math.max(n,.1),breakdown:t,combo:1+a}}function landMultiplier(e){return{1:1,2:.94,3:.92}[e]||0}function computeScore(e,n){if(!isValidCombo(e))return{valid:!1,base:0,combo:1,attempt:0,final:0,breakdown:[]};const{score:t,breakdown:i,combo:a}=baseScore(e),o=landMultiplier(n);return{valid:!0,base:round(t,3),combo:round(a,3),attempt:o,final:round(t*o,3),breakdown:i}}function round(e,n){const t=Math.pow(10,n);return Math.round(e*t)/t}function generateTrick(e){const n=tier(e),t=pickObstacle(),i={stance:null,spin:null,spin_dir:null,flip:null,grind_slide:null,direction:null,manual:null,obstacle:t,extras:[]};if(Math.random()<.1+.04*n){const e=stancePool(n);if(e.length){const n=e[Math.floor(Math.random()*e.length)];i.stance="regular"===n?null:n}}if(STATE.categories.spins&&Math.random()<.14+.05*n){const e=[180,360,540,720].filter((e=>STATE.spins[String(e)]&&allowSpin(e,n)));e.length&&(i.spin=e[Math.floor(Math.random()*e.length)],Math.random()<.6&&(i.spin_dir=Math.random()<.5?"frontside":"backside"))}if(STATE.categories.flips&&Math.random()<.24+.05*n){const e=RULES.FLIPS.filter((e=>STATE.flips[e]&&allowFlip(e,n)));e.length&&(i.flip=e[Math.floor(Math.random()*e.length)])}const a=RULES.GRIND_OK.has(t)||RULES.SLIDE_OK.has(t),o=RULES.MANUAL_OK.has(t),s=RULES.AIR_OK.has(t);return a&&STATE.categories.grinds&&Math.random()<.24+.04*n?(()=>{const e=RULES.GRINDS_SLIDES.filter((e=>STATE.grinds[e]&&allowGrindSlide(e,n)));e.length&&(i.grind_slide=e[Math.floor(Math.random()*e.length)],i.direction=RULES.DIRECTION_DEFAULTS[i.grind_slide]||"frontside")})():o&&STATE.categories.manuals&&Math.random()<.18+.03*n?i.manual="manual":s&&STATE.categories.airs&&!i.flip&&Math.random()<.36+.05*n&&(()=>{const e=["kickflip","heelflip","varial kickflip"].filter((e=>STATE.flips[e]&&allowFlip(e,n)));n>=7&&STATE.flips["tre flip"]&&e.push("tre flip"),e.length&&(i.flip=e[Math.floor(Math.random()*e.length)])})(),i.flip||i.grind_slide||i.manual||(s&&STATE.categories.flips?i.flip="kickflip":a&&STATE.categories.grinds?(i.grind_slide="50-50",i.direction=RULES.DIRECTION_DEFAULTS["50-50"]):o&&STATE.categories.manuals&&(i.manual="manual")),function(e){for(let n=0;n<8&&(!isValidCombo(e)||!underScoreCap(e)||!notTooSimilar(e));n++)if(isValidCombo(e))!underScoreCap(e)?e.spin?(e.spin=null,e.spin_dir=null):e.flip?e.flip=null:e.grind_slide&&(e.grind_slide=null,e.direction=null):notTooSimilar(e)||(e.flip&&Math.random()<.5&&(e.flip=null),e.grind_slide&&Math.random()<.5&&(e.grind_slide=null,e.direction=null),e.spin&&Math.random()<.5&&(e.spin=null,e.spin_dir=null));else if(e.grind_slide&&!(RULES.GRIND_OK.has(e.obstacle)||RULES.SLIDE_OK.has(e.obstacle))){const n=[...RULES.GRIND_OK,...RULES.SLIDE_OK].filter((e=>STATE.obstacles.includes(e)));n.length?e.obstacle=n[Math.floor(Math.random()*n.length)]:(e.grind_slide=null,e.direction=null)}else if(e.manual&&!RULES.MANUAL_OK.has(e.obstacle)){const n=[...RULES.MANUAL_OK].filter((e=>STATE.obstacles.includes(e)));n.length?e.obstacle=n[Math.floor(Math.random()*n.length)]:e.manual=null}else e.flip&&!e.grind_slide&&!e.manual&&!RULES.AIR_OK.has(e.obstacle)&&(()=>{const n=[...RULES.AIR_OK].filter((e=>STATE.obstacles.includes(e)));n.length?e.obstacle=n[Math.floor(Math.random()*n.length)]:e.flip=null})()}(i),i.spin||(i.spin_dir=null),pushRecent(i),i}function describe(e){const n=e.obstacle&&["rail","handrail","flatbar"].includes(e.obstacle),t=[];return e.flip&&!e.grind_slide&&!e.manual&&n?(t.push(e.flip,"over",e.obstacle),t.join(" ")):((e.stance&&"regular"!==e.stance&&t.push(e.stance),e.spin&&t.push(e.spin_dir?`${e.spin_dir} ${e.spin}`:`${e.spin}`),e.flip&&t.push(e.flip),e.direction&&e.grind_slide?t.push(`${e.direction} ${e.grind_slide}`):e.grind_slide&&t.push(e.grind_slide),e.manual&&t.push(e.manual),e.obstacle)&&t.push(`on ${e.obstacle}`),t.join(" "))}const els={skill:document.getElementById("skill"),skillVal:document.getElementById("skillVal"),startBtn:document.getElementById("startBtn"),gameCard:document.getElementById("gameCard"),setupCard:document.getElementById("setupCard"),overCard:document.getElementById("overCard"),trick:document.getElementById("trick"),letters:document.getElementById("letters"),landBtn:document.getElementById("landBtn"),missBtn:document.getElementById("missBtn"),skipBtn:document.getElementById("skipBtn"),nextBtn:document.getElementById("nextBtn"),endBtn:document.getElementById("endBtn"),attempt:document.getElementById("attempt"),score:document.getElementById("score"),finalScore:document.getElementById("finalScore"),bestScore:document.getElementById("bestScore"),restartBtn:document.getElementById("restartBtn"),breakdown:document.getElementById("breakdown"),breakText:document.getElementById("breakText"),settingsBtn:document.getElementById("settingsBtn"),settingsModal:document.getElementById("settingsModal"),settingsTitle:document.getElementById("settingsTitle"),settingsBack:document.getElementById("settingsBack"),settingsClose:document.getElementById("settingsClose"),settingsSave:document.getElementById("settingsSave"),exportFeedback:document.getElementById("exportFeedback"),clearCache:document.getElementById("clearCache"),obsChips:document.getElementById("obsChips"),catChips:document.getElementById("catChips"),stanceChips:document.getElementById("stanceChips"),obsNames:document.getElementById("obsNames"),editObs:document.getElementById("editObs")};function renderObsSummary(){els.obsNames.textContent=STATE.obstacles&&STATE.obstacles.length?STATE.obstacles.join(", "):"—"}els.skill.addEventListener("input",(e=>{els.skillVal.textContent=e.target.value})),renderObsSummary();const PANES=["settingsHome","obsPane","catPane","stancePane","tricksPane","aboutPane"];function openPane(e){PANES.forEach((n=>document.getElementById(n).classList.toggle("active",n===e))),els.settingsBack.classList.toggle("hidden","settingsHome"===e),els.settingsTitle.textContent="settingsHome"===e?"Settings":"obsPane"===e?"Obstacles":"catPane"===e?"Categories":"stancePane"===e?"Stances":"tricksPane"===e?"Tricks":"About & Tools"}function renderObsChips(){const e=ALL_OBS;els.obsChips.innerHTML=e.map((e=>`<button data-o="${e}" class="${STATE.obstacles.includes(e)?"active":""}">${e}</button>`)).join(""),els.obsChips.querySelectorAll("button").forEach((e=>{e.onclick=()=>{const n=e.dataset.o;STATE.obstacles=STATE.obstacles.includes(n)?STATE.obstacles.filter((e=>e!==n)):STATE.obstacles.concat([n]),renderObsChips()}}))}function renderCatChips(){const e=[["flips","Flips"],["grinds","Grinds/Slides"],["manuals","Manuals"],["airs","Airs"],["spins","Spins"]];els.catChips.innerHTML=e.map((([e,n])=>`<button data-k="${e}" class="${STATE.categories[e]?"active":""}">${n}</button>`)).join(""),els.catChips.querySelectorAll("button").forEach((e=>{e.onclick=()=>{const n=e.dataset.k;STATE.categories[n]=!STATE.categories[n],renderCatChips()}}))}function renderStanceChips(){const e=["regular","fakie","nollie","switch"];els.stanceChips.innerHTML=e.map((e=>`<button data-k="${e}" class="${STATE.stances[e]?"active":""}">${e}</button>`)).join(""),els.stanceChips.querySelectorAll("button").forEach((e=>{e.onclick=()=>{const n=e.dataset.k;STATE.stances[n]=!STATE.stances[n],renderStanceChips()}}))}function renderTrickPanels(){const e=els.settingsModal.querySelector(".panel.flips"),n=els.settingsModal.querySelector(".panel.grinds"),t=els.settingsModal.querySelector(".panel.spins");e.innerHTML=Object.keys(STATE.flips).map((e=>labelBox("flips",e,STATE.flips[e]))).join(""),n.innerHTML=Object.keys(STATE.grinds).map((e=>labelBox("grinds",e,STATE.grinds[e]))).join(""),t.innerHTML=Object.keys(STATE.spins).map((e=>labelBox("spins",e,STATE.spins[e]))).join(""),els.settingsModal.querySelectorAll(".tab").forEach((e=>{e.onclick=()=>{els.settingsModal.querySelectorAll(".tab").forEach((e=>e.classList.remove("active"))),e.classList.add("active"),els.settingsModal.querySelectorAll(".panel").forEach((e=>e.classList.add("hidden"))),els.settingsModal.querySelector(`.panel.${e.dataset.tab}`).classList.remove("hidden")}}))}function labelBox(e,n,t){const i=`${e}-${n}`.replace(/\s+/g,"-");return`<label><input id="${i}" type="checkbox" data-group="${e}" data-key="${n}" ${t?"checked":""}/> ${n}</label>`}els.settingsBtn.addEventListener("click",(()=>{openPane("settingsHome"),renderObsChips(),renderCatChips(),renderStanceChips(),renderTrickPanels(),els.settingsModal.classList.remove("hidden")})),els.settingsClose.addEventListener("click",(()=>els.settingsModal.classList.add("hidden"))),els.settingsBack.addEventListener("click",(()=>openPane("settingsHome"))),document.querySelectorAll("#settingsHome .list-item").forEach((e=>e.addEventListener("click",(()=>openPane(e.dataset.open))))),els.editObs.addEventListener("click",(()=>{els.settingsModal.classList.remove("hidden"),openPane("obsPane"),renderObsChips()})),document.addEventListener("change",(e=>{if(e.target&&e.target.matches('#settingsModal input[type=checkbox]')){const n=e.target.dataset.group,t=e.target.dataset.key;STATE[n]&&(STATE[n][t]=e.target.checked)}})),els.settingsSave.addEventListener("click",(()=>{saveState(STATE),renderObsSummary(),els.settingsModal.classList.add("hidden")})),els.clearCache&&els.clearCache.addEventListener("click",(async()=>{const e=await caches.keys();await Promise.all(e.map((e=>caches.delete(e)))),alert("Cache cleared. Reloading…"),location.reload(!0)})),els.exportFeedback&&els.exportFeedback.addEventListener("click",(()=>{const e=localStorage.getItem("bl_feedback")||"[]",n=document.createElement("a");n.href="data:application/json;charset=utf-8,"+encodeURIComponent(e),n.download="brainlock-feedback.json",n.click()}));let misses=0,total=0,current=null,attempt=1;function resetGameState(){misses=0,total=0,attempt=1,els.score.textContent=total.toFixed(2),updateLetters()}function startSession(){currentSkill=parseInt(els.skill.value,10),(!STATE.obstacles||0===STATE.obstacles.length)&&(STATE.obstacles=DEFAULTS.obstacles.slice()),saveState(STATE),resetGameState(),els.setupCard.classList.add("hidden"),els.overCard.classList.add("hidden"),els.gameCard.classList.remove("hidden"),nextTrick(!0)}function nextTrick(e=!1){attempt=1,els.attempt.textContent=attempt,current=generateTrick(currentSkill);for(let e=0;e<3&&(!current||!describe(current));e++)current=generateTrick(currentSkill);const n=describe(current)||"kickflip on flat";els.trick.textContent=n,els.breakdown.open=!1,els.nextBtn.classList.add("hidden"),els.landBtn.disabled=!1,els.missBtn.disabled=!1,els.skipBtn.disabled=!1,e||window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})}function settle(e){if(e){const e=computeScore(current,attempt);total+=e.final,els.score.textContent=total.toFixed(2),els.breakText.textContent=prettyScore(e),els.breakdown.open=!0,els.nextBtn.classList.remove("hidden"),els.landBtn.disabled=!0,els.missBtn.disabled=!0,els.skipBtn.disabled=!0}else attempt<3?(attempt++,els.attempt.textContent=attempt):(misses++,updateLetters(),misses>=5?endSession():(els.nextBtn.classList.remove("hidden"),els.landBtn.disabled=!0,els.missBtn.disabled=!0,els.skipBtn.disabled=!0))}function endSession(){els.gameCard.classList.add("hidden"),els.overCard.classList.remove("hidden"),els.finalScore.textContent=total.toFixed(2);const e=Math.max(total,parseFloat(localStorage.getItem("bl_best")||"0"));localStorage.setItem("bl_best",String(e)),els.bestScore.textContent=e.toFixed(2)}function updateLetters(){const e="SKATE".split("").map(((e,n)=>n<misses?`[${e}]`:e)).join(" ");els.letters.textContent=e}function prettyScore(e){if(!e.valid)return"Invalid combo for obstacle.";let n=[`Base: ${e.base}`,`Combo x${e.combo}`,`Attempt x${e.attempt} => Final: ${e.final}`,"","Breakdown:"];for(const[t,i,a]of e.breakdown)n.push(`  + ${t}:${i} = ${a}`);return n.join("\n")}els.startBtn.addEventListener("click",startSession),els.landBtn.addEventListener("click",(()=>settle(!0))),els.missBtn.addEventListener("click",(()=>settle(!1))),els.skipBtn.addEventListener("click",(()=>{els.nextBtn.classList.add("hidden"),nextTrick(!1)})),els.nextBtn.addEventListener("click",(()=>nextTrick(!1))),els.endBtn.addEventListener("click",endSession),els.restartBtn.addEventListener("click",(()=>{els.overCard.classList.add("hidden"),els.setupCard.classList.remove("hidden")})),"serviceWorker"in navigator&&window.addEventListener("load",(()=>navigator.serviceWorker.register("./sw.js"))),console.log("Brainlock loaded",VERSION);